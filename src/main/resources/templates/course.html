




<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì—¬í–‰ ê³„íš</title>
    <link href="https://getbootstrap.com/docs/5.3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link href="https://getbootstrap.com/docs/5.3/examples/sidebars/sidebars.css" rel="stylesheet">
    <style>
        #poi-info {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            background-color: rgba(255, 255, 255, 0.9);
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            font-family: sans-serif;
        }

        #poi-info div {
            margin-bottom: 10px;
        }

        #poi-info strong {
            font-weight: bold;
        }

        body {
            font-family: sans-serif;
        }

        .container {
            max-width: 85%;
            margin: 30px auto;
            padding: 20px;
            border: 1px solid #dee2e6;
            border-radius: 0.25rem;
        }

        .grid-container {
            display: grid;
            grid-template-columns: 1fr 2fr 1fr;
            grid-template-rows: auto auto auto;
            gap: 15px;
        }

        .participants-section, .cost-section, .course-a-section, .course-b-section, .memo-section {
            border: 1px solid #ced4da;
            border-radius: 0.25rem;
            padding: 10px;
        }

        #map {
            width: 100%;
            height: 600px;
            border: 1px solid #ced4da;
            border-radius: 0.25rem;
        }

        .button-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .course-details-container {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
        }

        .participants-section {
            grid-column: 1 / 2;
            grid-row: 1 / 2;
        }

        .cost-section {
            grid-column: 1 / 2;
            grid-row: 2 / 3;
        }

        #map {
            grid-column: 2 / 3;
            grid-row: 1 / 3;
        }

        .button-section {
            grid-column: 3 / 4;
            grid-row: 1 / 2;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: stretch;
        }

        .button-section button {
            margin-bottom: 5px;
        }

        .course-details-container {
            grid-column: 1 / 4;
            grid-row: 3 / 4;
        }

        .course-a-section {

        }

        .course-b-section {

        }

        .memo-section {

        }

        .course-a-section h4, .course-b-section h4 {
            margin-bottom: 10px;
            font-weight: bold;
        }

        .course-a-section p, .course-b-section p {
            margin-bottom: 5px;
        }
    </style>
    <link href="/css/header.css" rel="stylesheet">
</head>
<body>
<header class="header-area">
    <div th:replace="~{header.html}"></div>
</header>

<div class="container">
    <div class="grid-container">
        <div class="participants-section">
            <h4>ì°¸ì—¬ì <span class="badge bg-secondary" id="participant-count">0ëª…</span></h4>
            <ul class="list-unstyled" id="participant-list">
                <!-- ë™ì ìœ¼ë¡œ ì¶”ê°€ë  ì°¸ì—¬ì ëª©ë¡ -->
            </ul>
        </div>

        <div class="cost-section">
            <h4>ì˜ˆìƒ ê²¬ì ë¹„</h4>
            <ul class="list-unstyled">
                <li id="fullfuel-cost"></li>
                <li id="fuel-cost"></li>
            </ul>
        </div>

        <div id="map"></div>

        <div class="button-section">
            <input type="text" class="btn btn-dark w-100" id="searchInput" placeholder="ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
            <br>
            <button type="button" class="btn btn-success" onclick="searchPoi();" id="searchPoiButton">ì£¼ë³€ ê´€ê´‘ì§€ ê²€ìƒ‰</button>

            <button type="button" class="btn btn-primary" id="pay-button" onclick="openPayPopup()">ê²°ì œí•˜ê¸°</button>
            <div class="d-flex flex-column align-items-stretch flex-shrink-0 bg-body-tertiary border border-r-1"
                 style="width: 450px; height: 500px">
                <div class="d-flex align-items-center flex-shrink-0 p-3 link-body-emphasis text-decoration-none" id="summary-title">
                    <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" fill="#4ae39c" viewBox="0 0 256 256" class="me-2">
                        <path d="M232,128A104,104,0,1,1,128,24,104.13,104.13,0,0,1,232,128Z"></path>
                    </svg>
                    <span class="fs-5 fw-semibold">ì½”ìŠ¤ ì†Œê°œ</span>
                    <button type="button" class="btn btn-dark btn-sm ms-2" onclick="fetchCourseList(bNum)">ì½”ìŠ¤ VRP</button>
                </div>
                <div class="d-flex flex-wrap py-3 px-2 gap-3 align-items-center justify-content-center border-bottom" id="summary-section">
                    <div class="d-flex flex-column align-items-center">
                        <div id="totalVisit"></div>
                        <div class="fw-light" style="font-size:.75rem">ê²½ìœ ì§€</div>
                    </div>
                    <div class="border-start border-2 h-50"></div>
                    <div class="d-flex flex-column align-items-center">
                        <div id="totalDistance"></div>
                        <div class="fw-light" style="font-size:.75rem">ì´ë™ê±°ë¦¬</div>
                    </div>
                    <div class="border-start border-2 h-50"></div>
                    <div class="d-flex flex-column align-items-center">
                        <div id="totalDuration"></div>
                        <div class="fw-light" style="font-size:.75rem">ì´ë™ì‹œê°„</div>
                    </div>
                </div>
                <div class="list-group scrollarea px-3 flex-grow-1" id="nodeList">

                </div>
            </div>
        </div>

        <div class="course-details-container">
            <div class="course-a-section">

            </div>
            <div class="course-b-section">

                <div class="mb-3">
                    <a id="oLink2" style="
    display: inline-block;
    padding: 10px 20px;
    background-color: #007bff; /* ë°°ê²½ìƒ‰ */
    color: white; /* ê¸€ììƒ‰ */
    text-decoration: none; /* ë°‘ì¤„ ì œê±° */
    border-radius: 5px; /* ë‘¥ê·¼ ëª¨ì„œë¦¬ */
    font-weight: bold; /* ê¸€ì êµµê²Œ */
    box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.2); /* ê·¸ë¦¼ì íš¨ê³¼ */
    transition: background-color 0.3s ease; /* ë¶€ë“œëŸ¬ìš´ ë°°ê²½ìƒ‰ ì „í™˜ íš¨ê³¼ */
">ì˜¤í”ˆí†¡ ê°€ê¸°!</a>

                    <input type="text" class="form-control" id="oLink" placeholder="ì˜¤í”ˆ ì±„íŒ…ë°© ë§í¬ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”" />
                </div>

            </div>
            <div class="memo-section">

                <h4>ì˜¤í”ˆí†¡ë°© ì œëª© ê·œì¹™</h4>

              <label>ğŸ“¢ ì œëª© : [ëª©ì ì§€] [ë‚ ì§œ] ì¼ì •! ì¡´ëŒ“ë§ë¡œ ì†Œí†µí•´ìš” ğŸ¤— í†¡ë°© ë§¤ë„ˆ í•„ìˆ˜!</label>
            </div>
            <div id="apply-list-container"></div>
        </div>
    </div>
</div>
<script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=2d9eb0b403c46eb5f1bd564c9b9149d1&libraries=services"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>



    function spinOn() {
        $("#spin").addClass("d-flex");
    }

    function spinOff() {
        $("#spin").removeClass("d-flex");
    }

    console.log((typeof kakao));
    var container = document.getElementById('map');
    var options = {
        center: new kakao.maps.LatLng(37.5665, 126.9780),
        level: 4
    };
    var map = new kakao.maps.Map(container, options);
    var geocoder = new kakao.maps.services.Geocoder();
    let urlParams = new URLSearchParams(window.location.search);
    const encodedAddress = urlParams.get('addressFromPos');
    const addressFromPost = decodeURIComponent(encodedAddress);

    spinOn();
    geocoder.addressSearch(addressFromPost, function (result, status) {
        spinOff();
        if (status === kakao.maps.services.Status.OK) {
            var coords = new kakao.maps.LatLng(result[0].y, result[0].x);
            map.setCenter(coords);
            var marker = new kakao.maps.Marker({
                map: map,
                position: coords
            });
            var infowindow = new kakao.maps.InfoWindow({
                content: '<div style="width:150px;text-align:center;padding:6px 0;">' + addressFromPost + '</div>'
            });
            // infowindow.open(map, marker);
            marker.setMap(null); // ì¤‘ì‹¬ì§€ ë§ˆì»¤ ìˆ¨ê¸°ê¸°
        } else {
        }
    });


    function loadInitialData() {
        clearAnimation(); // ì• ë‹ˆë©”ì´ì…˜ ì´ˆê¸°í™” í•¨ìˆ˜ í˜¸ì¶œ
        clearManualMarkers(); // ìˆ˜ë™ ë§ˆì»¤ ë° ê²½ë¡œ ì œê±° (â˜…â˜…â˜…â˜…â˜… ì¶”ê°€ â˜…â˜…â˜…â˜…â˜…)
        spinOn();
        $.ajax({
            url: `/cpoi?bNum=${bNum}`,
            type: 'get',
            success: function (result) {
                if (result.code != 'SUCC') {
                    alert("ì´ˆê¸° ë°ì´í„° ë¡œë”©ì— ì‹¤íŒ¨.");
                    spinOff();
                    return;
                }
                const data = result.data;
                displayData3(data);
                goVrp();

            },
            error: function () {
                alert("ì´ˆê¸° ë°ì´í„° ë¡œë”©ì— ì‹¤íŒ¨");
                spinOff();
            }
        });

    }
    function openPayPopup() {

        const totalDistanceElement = document.getElementById("totalDistance");
        const totalDistanceText = totalDistanceElement.textContent;
        const totalDistanceValue = parseFloat(totalDistanceText.replace("km", ""));
        const urlParams = new URLSearchParams(window.location.search);
        const countPeople = urlParams.get('countPeople');
        const countPeopleNum = parseInt(countPeople);
        const divisor = countPeopleNum - 1;
        const fuelCost = Math.round(totalDistanceValue * 1700/15 / divisor);

        let url = `/payForm`;
        if (bNum) {
            url += `?bNum=${bNum}&fuelCost=${fuelCost}&bNum=${bNum}`;
        } else {
            url += `?fuelCost=${fuelCost}`;
        }

        const options = "width=600, height=400, top=100, left=100, resizable=yes, scrollbars=yes";
        window.open(url, "payPopup", options);
    }
    function boardToHistoryAjax() {

        const bNum = new URLSearchParams(window.location.search).get("bNum");
        fetch('/boardToHistory', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: `BNum=${bNum}`
        })
            .then(response => {
                if (!response.ok) {
                    return response.text().then(errorMessage => {
                        throw new Error(errorMessage || 'ì„œë²„ ì˜¤ë¥˜ ë°œìƒ');
                    });
                }
                return response.text();
            })
            .then(message => {
                alert(message);
                window.location.href = `/RWriteForm?bNum=${bNum}`;
            })
            .catch(error => {
                console.error('AJAX ìš”ì²­ ì—ëŸ¬:', error);
                if (error.message === 'ì„œë²„ ì˜¤ë¥˜ ë°œìƒ') {
                    alert('ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                } else {
                    alert('ìš”ì²­ ì‹¤íŒ¨: ' + error.message);
                }
            });
    }
    function searchPoi() {
        clearAnimation(); // ì• ë‹ˆë©”ì´ì…˜ ì´ˆê¸°í™” í•¨ìˆ˜ í˜¸ì¶œ
        clearManualMarkers(); // ìˆ˜ë™ ë§ˆì»¤ ë° ê²½ë¡œ ì œê±° (â˜…â˜…â˜…â˜…â˜… ì¶”ê°€ â˜…â˜…â˜…â˜…â˜…)
        var latlng = map.getCenter();
        const x = latlng.getLng();
        const y = latlng.getLat();
        const keyword = $("#searchInput").val();
        const combinedValue = `${addressFromPost} ${keyword}`;
        spinOn();
        $.ajax({
            url: '/poi',
            data: {
                x: x,
                y: y,
                keyword: combinedValue
            },
            success: function (result) {
                if (result.code != 'SUCC') {
                    // alert("ì£¼ë³€ ê´€ê´‘ì§€ ê²€ìƒ‰ì— ì‹¤íŒ¨.");
                    spinOff();
                    return;
                }
                const data = result.data;

                displayData2(data, true);
            },
            error: function () {
                // alert("ì£¼ë³€ ê´€ê´‘ì§€ ê²€ìƒ‰ì— ì‹¤íŒ¨");
                spinOff();
            }
        });
    }


    let POLYLINE = null;
    let totalPathPointList = [];
    let totalDistance = 0;
    let totalDuration = 0;
    let nodeList = [];
    const NODE_MAP = {};
    const MARKER_MAP = {};
    const INFO_MAP = {};

    function displayData(data) {
        clearNode();
        clearManualMarkers(); // ìˆ˜ë™ ë§ˆì»¤ ë° ê²½ë¡œ ì œê±° (â˜…â˜…â˜…â˜…â˜… ì¶”ê°€ â˜…â˜…â˜…â˜…â˜…)
        totalDistance = data.totalDistance;
        totalDuration = data.totalDuration;
        totalPathPointList = data.totalPathPointList;
        nodeList = data.nodeList;

        $("#totalVisit").text(nodeList.length + "ê³³");
        $("#totalDistance").text((totalDistance / 1000).toFixed(2) + "km");
        $("#totalDuration").text(secondsToHoursMinutes(totalDuration));
        let html = '';
        let count = 0;
        var bounds = new kakao.maps.LatLngBounds();
        for (const node of nodeList) {
            NODE_MAP[node.id] = node;

            let listItemClass = "list-group-item list-group-item-action py-3 lh-sm mt-3 border rounded-2";
            if (count === 0) {
                listItemClass += " start-point"
            }
            else if (count === nodeList.length - 1) {
                listItemClass += " end-point"
            }

            html += `
<a href="javascript:panTo(${node.id});" class="${listItemClass}" data-node-id="${node.id}" data-x="${node.x}" data-y="${node.y}">
  <div class="d-flex w-100 align-items-center justify-content-start mb-1">
    <span class="badge text-bg-secondary">${++count}</span><strong class="ms-1">${node.name}</strong>
  </div>
  <div class="mt-3 small">
    <div class="d-flex align-items-center justify-content-between">
      <div class="d-flex align-items-center"><span class="badge text-bg-light border border-secondary-subtle me-2">ì£¼ì†Œ</span> <span>${node.address}</span></div>
      ${node.phone == null ? '' : `
         <div class="d-flex align-items-center">
            <span class="badge text-bg-light border border-secondary-subtle me-2">ì „í™”</span>
            <span>${node.phone}</span>
          </div>
      `}
    </div>
  </div>
  <div class="mt-2 d-flex justify-content-between align-items-center">
    <button class="btn btn-danger btn-sm delete-node-button" id="delete-node-${node.id}" onclick="deleteNode(${node.id})">ì‚­ì œ</button>
  </div>
</a>

`;
            drawMarker(node, bounds,count,nodeList.length);
        }
        if (nodeList.length > 0) {
            map.setBounds(bounds);
        }
        $("#nodeList").html(html);
        // ì• ë‹ˆë©”ì´ì…˜ ì‹œì‘ (ê²½ë¡œê°€ ìˆê³ , ì¶œë°œì§€ì™€ ë„ì°©ì§€ê°€ ìˆëŠ” ê²½ìš°)
        if (totalPathPointList.length > 1 && nodeList.length >= 2) {
            // alert("ì°¨ ë‹¬ë¦¬ê¸°ì‹œì‘");
            animateMarker(totalPathPointList); // ìˆ˜ì •ëœ animateMarker í•¨ìˆ˜ í˜¸ì¶œ
            updateFuelCost();
            function updateFuelCost() {

                const totalDistanceElement = document.getElementById("totalDistance");
                const totalDistanceText = totalDistanceElement.textContent;
                const totalDistanceValue = parseFloat(totalDistanceText.replace("km", ""));
                const urlParams = new URLSearchParams(window.location.search);
                const countPeople = urlParams.get('countPeople');
                const countPeopleNum = parseInt(countPeople);
                const divisor = countPeopleNum - 1;
                const fuelCost = Math.round(totalDistanceValue * 1700/15 / divisor);
                const fullcost = Math.round(totalDistanceValue * 1700 /15);
                // HTML ìš”ì†Œ ì°¾ê¸°
                const fuelCostElement = document.getElementById("fuel-cost");
                const fullfuelCost = document.getElementById("fullfuel-cost")


                // ì—°ë£Œë¹„ ê°’ HTMLì— ì—…ë°ì´íŠ¸
                if (fuelCostElement) {
                    fuelCostElement.textContent = `ì—°ë£Œë¹„: ${fuelCost} ì›`;
                    fullfuelCost.textContent = `ì´ì—°ë£Œë¹„: ${fullcost} ì›`;
                } else {
                    console.error("fuel-cost ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                }
            }
        } else {
            alert("ì°¨ ë‹¬ë¦¬ê¸° ì‹¤íŒ¨");
        }

        spinOff();
    }

    let animatedOverlay = null; // ì• ë‹ˆë©”ì´ì…˜ ì˜¤ë²„ë ˆì´ (ë§ˆì»¤ ëŒ€ì‹ )
    let animationInterval = null; // ì• ë‹ˆë©”ì´ì…˜ interval ì €ì¥
    let carImageElement = null; // ìë™ì°¨ ì´ë¯¸ì§€ ìš”ì†Œ

    function animateMarker(pathPoints) { // animateMarker í•¨ìˆ˜ (ìˆ˜ì •ë¨)
        clearAnimation();
        if (animatedOverlay) {
            animatedOverlay.setMap(null); // ê¸°ì¡´ ì˜¤ë²„ë ˆì´ ì œê±°
        }

        // ìë™ì°¨ ì´ë¯¸ì§€ ìš”ì†Œ ìƒì„± (ì• ë‹ˆë©”ì´ì…˜ ì‹œì‘ ì‹œì ì— í•œ ë²ˆë§Œ ìƒì„±)
        if (!carImageElement) {
            carImageElement = document.createElement('img');
            carImageElement.src = '/images/car.png'; // ìë™ì°¨ ì´ë¯¸ì§€ ê²½ë¡œ í™•ì¸
            carImageElement.style.width = '30px'; // ì´ë¯¸ì§€ í¬ê¸° ì¡°ì • (ì›í•˜ëŠ” í¬ê¸°ë¡œ)
            carImageElement.style.transition = 'transform 0.1s linear'; // íšŒì „ ë¶€ë“œëŸ½ê²Œ
        }

        // CustomOverlay ìƒì„± (ì²˜ìŒ ìœ„ì¹˜ì—)
        animatedOverlay = new kakao.maps.CustomOverlay({
            position: new kakao.maps.LatLng(pathPoints[0].y, pathPoints[0].x),
            content: carImageElement, // ì´ë¯¸ì§€ ìš”ì†Œë¥¼ ë‚´ìš©ìœ¼ë¡œ ì„¤ì •
            map: map
        });

        let pointIndex = 1;
        animationInterval = setInterval(function () {
            if (pointIndex < pathPoints.length) {
                var prevPoint = pathPoints[pointIndex - 1];
                var thisPoint = pathPoints[pointIndex];

                var deg = getBearing(prevPoint.x, prevPoint.y, thisPoint.x, thisPoint.y); // getBearing í•¨ìˆ˜ ì‚¬ìš©

                moveVehicle(pathPoints[pointIndex], deg); // moveVehicle í•¨ìˆ˜ í˜¸ì¶œ
                pointIndex++;
            } else {
                // clearInterval(animationInterval); // ì• ë‹ˆë©”ì´ì…˜ ì¢…ë£Œ - ì´ ì¤„ì„ ì œê±°!
                pointIndex = 1; // pointIndexë¥¼ 1ë¡œ ì¬ì„¤ì •í•˜ì—¬ ë°˜ë³µ ì‹œì‘
                // (ì„ íƒ ì‚¬í•­) ì‹œì‘ì ìœ¼ë¡œ ë°”ë¡œ ëŒì•„ê°€ê²Œ í•˜ë ¤ë©´ ë‹¤ìŒ ì¤„ì„ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                // moveVehicle(pathPoints[0], getBearing(pathPoints[0].x, pathPoints[0].y, pathPoints[1].x, pathPoints[1].y));
            }
        }, 30);
    }

    function moveVehicle(point, deg) { // moveVehicle í•¨ìˆ˜ (ìˆ˜ì •ë¨)
        if (animatedOverlay && carImageElement) {
            carImageElement.style.transform = 'rotate(' + (deg - 90) + 'deg)'; // -90ë„ ë³´ì • (ì´ë¯¸ì§€ ë°©í–¥ì— ë”°ë¼ ì¡°ì •)
            var position = new kakao.maps.LatLng(point.y, point.x);
            animatedOverlay.setPosition(position);
        }
    }

    function getBearing(x1, y1, x2, y2) { // getBearing í•¨ìˆ˜ (ì˜ˆì œ ì½”ë“œì—ì„œ ì¶”ê°€)
        // ìœ„ë„, ê²½ë„ë¥¼ ë¼ë””ì•ˆ ë‹¨ìœ„ë¡œ ë³€í™˜
        var radY1 = y1 * Math.PI / 180;  // latitude y
        var radX1 = x1 * Math.PI / 180;  // longitude x
        var radY2 = y2 * Math.PI / 180;
        var radX2 = x2 * Math.PI / 180;

        var deltaX = radX2 - radX1;

        var y = Math.sin(deltaX) * Math.cos(radY2);
        var x = Math.cos(radY1) * Math.sin(radY2) -
            Math.sin(radY1) * Math.cos(radY2) * Math.cos(deltaX);
        var bearing = Math.atan2(y, x) * 180 / Math.PI;
        return (bearing + 360) % 360; // 0~360ë„ ë²”ìœ„ë¡œ ì¡°ì •
    }

    //     // ì• ë‹ˆë©”ì´ì…˜ ì‹œì‘ (ê²½ë¡œê°€ ìˆê³ , ì¶œë°œì§€ì™€ ë„ì°©ì§€ê°€ ìˆëŠ” ê²½ìš°)
    //     if (totalPathPointList.length > 1 && nodeList.length >= 2) {
    //         alert("ì°¨ ë‹¬ë¦¬ê¸°ì‹œì‘");
    //         animateMarker(totalPathPointList);
    //     }else{
    //         alert("ì°¨ ë‹¬ë¦¬ê¸° ì‹¤íŒ¨");
    //     }
    //
    //     spinOff();
    // }
    //
    // let animatedMarker = null; // ì• ë‹ˆë©”ì´ì…˜ ë§ˆì»¤ ì „ì—­ ë³€ìˆ˜
    // let animationInterval = null; // ì• ë‹ˆë©”ì´ì…˜ interval ì €ì¥
    //
    //
    // function animateMarker(pathPoints) { // animateMarker í•¨ìˆ˜ (ê¸°ì¡´ ì½”ë“œ í™œìš©)
    //     if (animatedMarker) {
    //         animatedMarker.setMap(null);
    //     }
    //     animatedMarker = new kakao.maps.Marker({
    //         position: new kakao.maps.LatLng(pathPoints[0].y, pathPoints[0].x),
    //         map: map,
    //         image: new kakao.maps.MarkerImage(
    //             '/images/car.png',
    //             new kakao.maps.Size(30, 30),
    //             {
    //                 offset: new kakao.maps.Point(15, 30),
    //                 rotation: 0 // ì´ˆê¸° íšŒì „ ê°ë„ 0ìœ¼ë¡œ ì„¤ì •
    //             }
    //         )
    //     });
    //
    //     let pathIndex = 1;
    //     animationInterval = setInterval(function() {
    //         if (pathIndex < pathPoints.length) {
    //             const currentPoint = pathPoints[pathIndex - 1]; // í˜„ì¬ ì¢Œí‘œ
    //             const nextPoint = pathPoints[pathIndex];       // ë‹¤ìŒ ì¢Œí‘œ
    //
    //             const currentLatLng = new kakao.maps.LatLng(currentPoint.y, currentPoint.x);
    //             const nextLatLng = new kakao.maps.LatLng(nextPoint.y, nextPoint.x);
    //
    //             // ë‘ ì§€ì  ì‚¬ì´ì˜ ê°ë„ ê³„ì‚° (degree ë‹¨ìœ„)
    //             const angle = calculateAngle(currentLatLng, nextLatLng);
    //
    //             // íšŒì „ ê°ë„ë¥¼ ì ìš©í•œ ìƒˆ MarkerImage ìƒì„±
    //             const rotatedImage = new kakao.maps.MarkerImage(
    //                 '/images/car.png',
    //                 new kakao.maps.Size(30, 30),
    //                 {
    //                     offset: new kakao.maps.Point(15, 30),
    //                     rotation: angle // ê³„ì‚°ëœ ê°ë„ ì ìš©
    //                 }
    //             );
    //
    //             animatedMarker.setImage(rotatedImage); // ë§ˆì»¤ ì´ë¯¸ì§€ ì—…ë°ì´íŠ¸
    //             animatedMarker.setPosition(nextLatLng);   // ë§ˆì»¤ ìœ„ì¹˜ ì´ë™
    //
    //             pathIndex++;
    //         } else {
    //             pathIndex = 0;
    //             let startPoint = pathPoints[0];
    //             let startLatLng = new kakao.maps.LatLng(startPoint.y, startPoint.x);
    //             animatedMarker.setPosition(startLatLng);
    //         }
    //     }, 100);
    // }
    //
    // // ë‘ LatLng ì§€ì  ì‚¬ì´ì˜ ê°ë„ë¥¼ degree ë‹¨ìœ„ë¡œ ê³„ì‚°í•˜ëŠ” í•¨ìˆ˜
    // function calculateAngle(latlng1, latlng2) { // calculateAngle í•¨ìˆ˜ (ê¸°ì¡´ ì½”ë“œ í™œìš©)
    //     const lat1 = latlng1.getLat();
    //     const lng1 = latlng1.getLng();
    //     const lat2 = latlng2.getLat();
    //     const lng2 = latlng2.getLng();
    //
    //     const deltaLng = lng2 - lng1;
    //     const deltaLat = lat2 - lat1;
    //
    //     let angleRad = Math.atan2(deltaLng, deltaLat); // ë¼ë””ì•ˆ ê°ë„ ê³„ì‚°
    //     let angleDeg = angleRad * (180 / Math.PI);     // degree ë¡œ ë³€í™˜
    //
    //     // ê°ë„ ë³´ì •: ë§ˆì»¤ ì´ë¯¸ì§€ê°€ Yì¶• ë°©í–¥ì„ ê¸°ì¤€ìœ¼ë¡œ íšŒì „í•˜ë¯€ë¡œ, ë³´ì •ì´ í•„ìš”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    //     // í•„ìš”ì— ë”°ë¼ ì•„ë˜ ë³´ì •ê°’ì„ ì¡°ì ˆí•˜ê±°ë‚˜ ì œê±°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    //
    //     // angleDeg = angleDeg - 90; // ì˜ˆì‹œ: -90ë„ ë³´ì • (ì°¨ëŸ‰ ì´ë¯¸ì§€ ë°©í–¥ì— ë”°ë¼ ì¡°ì ˆ)
    //
    //     return angleDeg;
    // }
    function clearAnimation() {
        if (animatedOverlay) {
            animatedOverlay.setMap(null); // ì§€ë„ì—ì„œ ì• ë‹ˆë©”ì´ì…˜ ì˜¤ë²„ë ˆì´ ì œê±°
            animatedOverlay = null; // ë³€ìˆ˜ ì´ˆê¸°í™”
        }
        if (animationInterval) {
            clearInterval(animationInterval); // ì• ë‹ˆë©”ì´ì…˜ interval ì¤‘ì§€
            animationInterval = null; // ë³€ìˆ˜ ì´ˆê¸°í™”
        }
    }
    function displayData2(data) {
        clearNode();
        clearManualMarkers(); // ìˆ˜ë™ ë§ˆì»¤ ë° ê²½ë¡œ ì œê±° (â˜…â˜…â˜…â˜…â˜… ì¶”ê°€ â˜…â˜…â˜…â˜…â˜…)
        totalDistance = data.totalDistance;
        totalDuration = data.totalDuration;
        totalPathPointList = data.totalPathPointList;
        nodeList = data.nodeList;

        // $("#totalVisit").text(nodeList.length + "ê³³");
        // $("#totalDistance").text((totalDistance / 1000).toFixed(2) + "km");
        // $("#totalDuration").text(secondsToHoursMinutes(totalDuration));

        let html = '';
        let count = 0;
        var bounds = new kakao.maps.LatLngBounds();
        for (const node of nodeList) {
            NODE_MAP[node.id] = node;
            let listItemClass = "list-group-item list-group-item-action py-3 lh-sm mt-3 border rounded-2";
            if (count === 0) {
                listItemClass += " start-point"
            }
            else if (count === nodeList.length - 1) {
                listItemClass += " end-point"
            }

            html += `
    <a href="javascript:panTo(${node.id});" class="${listItemClass}" data-node-id="${node.id}" data-x="${node.x}" data-y="${node.y}">
      <div class="d-flex w-100 align-items-center justify-content-start mb-1">
        <span class="badge text-bg-secondary">${++count}</span><strong class="ms-1">${node.name}</strong>
      </div>
      <div class="mt-3 small">
        <div class="d-flex align-items-center justify-content-between">
          <div class="d-flex align-items-center"><span class="badge text-bg-light border border-secondary-subtle me-2">ì£¼ì†Œ</span> <span>${node.address}</span></div>
          ${node.phone == null ? '' : `
             <div class="d-flex align-items-center">
                <span class="badge text-bg-light border border-secondary-subtle me-2">ì „í™”</span>
                <span>${node.phone}</span>
              </div>
          `}
        </div>
      </div>
      <div class="mt-2 d-flex justify-content-between align-items-center">
        <button class="btn btn-success btn-sm add-to-course-button" data-node-id="${node.id}">ì¶”ê°€</button>
      </div>
    </a>
  `;
            drawMarker(node, bounds,count,nodeList.length, true);
        }
        if (nodeList.length > 0) {
            map.setBounds(bounds);
        }
        $("#nodeList").html(html);
        spinOff();
    }

    function displayData3(data) {
        clearNode();
        clearManualMarkers(); // ìˆ˜ë™ ë§ˆì»¤ ë° ê²½ë¡œ ì œê±° (â˜…â˜…â˜…â˜…â˜… ì¶”ê°€ â˜…â˜…â˜…â˜…â˜…)
        totalDistance = data.totalDistance;
        totalDuration = data.totalDuration;
        totalPathPointList = data.totalPathPointList;
        nodeList = data.nodeList;

        // $("#totalVisit").text(nodeList.length + "ê³³");
        // $("#totalDistance").text((totalDistance / 1000).toFixed(2) + "km");
        // $("#totalDuration").text(secondsToHoursMinutes(totalDuration));

        let html = '';
        let count = 0;
        var bounds = new kakao.maps.LatLngBounds();
        for (const node of nodeList) {
            NODE_MAP[node.id] = node;
            let listItemClass = "list-group-item list-group-item-action py-3 lh-sm mt-3 border rounded-2";
            if (count === 0) {
                listItemClass += " start-point"
            }
            else if (count === nodeList.length - 1) {
                listItemClass += " end-point"
            }

            html += `
    <a href="javascript:panTo(${node.id});" class="${listItemClass}" data-node-id="${node.id}" data-x="${node.x}" data-y="${node.y}">
      <div class="d-flex w-100 align-items-center justify-content-start mb-1">
        <span class="badge text-bg-secondary">${++count}</span><strong class="ms-1">${node.name}</strong>
      </div>
      <div class="mt-3 small">
        <div class="d-flex align-items-center justify-content-between">
          <div class="d-flex align-items-center"><span class="badge text-bg-light border border-secondary-subtle me-2">ì£¼ì†Œ</span> <span>${node.address}</span></div>
          ${node.phone == null ? '' : `
             <div class="d-flex align-items-center">
                <span class="badge text-bg-light border border-secondary-subtle me-2">ì „í™”</span>
                <span>${node.phone}</span>
              </div>
          `}
        </div>
      </div>
      <div class="mt-2 d-flex justify-content-between align-items-center">

      </div>
    </a>
  `;
            drawMarker(node, bounds,count,nodeList.length, true);
        }
        if (nodeList.length > 0) {
            map.setBounds(bounds);
        }
        $("#nodeList").html(html);
        spinOff();
    }


    function secondsToHoursMinutes(seconds) {
        const hours = Math.floor(seconds / 3600);
        const minutes = Math.floor((seconds % 3600) / 60);
        const formattedHours = hours > 0 ? `${hours.toString().padStart(2, '0')}ì‹œê°„ ` : '';
        const formattedMinutes = minutes.toString().padStart(2, '0');
        return `${formattedHours}${formattedMinutes}ë¶„`;
    }

    function drawMarker(node, bounds, count, nodeLength, isSearch = false) {
        const position = new kakao.maps.LatLng(node.y, node.x);
        bounds.extend(position);
        let markerClass = "kakaoMarker";
        let markerImage = null;

        if(isSearch){
            markerImage = new kakao.maps.MarkerImage(
                'https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/markerStar.png', // ê¸°ë³¸ ë§ˆì»¤ ì´ë¯¸ì§€ URL
                new kakao.maps.Size(24, 35),
                { offset: new kakao.maps.Point(13, 35) }
            );
            markerClass += " search-point";
        }else{
            if (count === 1) {
                markerClass += " start-point";
                markerImage = new kakao.maps.MarkerImage(
                    "https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/red_b.png",
                    new kakao.maps.Size(50, 45),
                    { offset: new kakao.maps.Point(13, 35) }
                );
            } else
            if (count === nodeLength) {
                markerClass += " end-point";
                markerImage = new kakao.maps.MarkerImage(
                    "https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/blue_b.png",
                    new kakao.maps.Size(50, 45),
                    { offset: new kakao.maps.Point(13, 35) }
                );
            } else {
                markerClass += " waypoint-point";
                markerImage = new kakao.maps.MarkerImage(
                    "https://t1.daumcdn.net/localimg/localimages/07/2018/pc/flagImg/green_b_1.png", // ê²½ìœ ì§€ ì´ë¯¸ì§€
                    new kakao.maps.Size(24, 35),
                    { offset: new kakao.maps.Point(13, 35) }
                );
            }
        }
        const marker = new kakao.maps.Marker({
            position: position,
            clickable: true,
            image: markerImage
        });
        marker.setMap(map);

        const name = node.name;
        const phone = node.phone;
        const phoneText = phone ? phone : ""; // ìˆ˜ì •ëœ ë¶€ë¶„
        const infowindow = new kakao.maps.InfoWindow({
            content: `<div class ="${markerClass}"style="padding:5px;">` + name + '<br/>' + phoneText + '</div>', // ìˆ˜ì •ëœ ë¶€ë¶„
            removable: true
        });

        MARKER_MAP[node.id] = marker;
        INFO_MAP[node.id] = infowindow;

        kakao.maps.event.addListener(marker, 'click', function () {
            infowindow.open(map, marker);
        });
    }
    function drawPath(pathPointList) {
        if (pathPointList.length > 0) {
            var linePath = [];
            for (var point of pathPointList) {
                linePath.push(new kakao.maps.LatLng(point.y, point.x));
            }
            POLYLINE = new kakao.maps.Polyline({
                path: linePath,
                strokeWeight: 5,
                strokeColor: 'red',
                strokeOpacity: 0.7,
                strokeStyle: 'solid'
            });
            POLYLINE.setMap(map);
        }
    }

    function panTo(nodeId) {
        clearInfoWindow();
        const node = NODE_MAP[nodeId];
        INFO_MAP[nodeId].open(map, MARKER_MAP[nodeId]);
        var moveLatLon = new kakao.maps.LatLng(node.y, node.x);
        map.panTo(moveLatLon);
    }

    function clearInfoWindow() {
        for (const nodeId in INFO_MAP) {
            INFO_MAP[nodeId].close();
        }
    }

    function clearNode() {
        for (const nodeId in NODE_MAP) {
            MARKER_MAP[nodeId].setMap(null);
            MARKER_MAP[nodeId] = null;
            INFO_MAP[nodeId].close();
            INFO_MAP[nodeId] = null;
            delete MARKER_MAP[nodeId];
            delete INFO_MAP[nodeId];
            delete NODE_MAP[nodeId];
        }
        if (POLYLINE) {
            POLYLINE.setMap(null);
            POLYLINE = null;
        }
    }

    function goVrp() {

        clearAnimation();
        clearManualMarkers(); // ìˆ˜ë™ ë§ˆì»¤ ë° ê²½ë¡œ ì œê±° (â˜…â˜…â˜…â˜…â˜… ì¶”ê°€ â˜…â˜…â˜…â˜…â˜…)
        spinOn();
        var latlng = map.getCenter();
        const x = latlng.getLng();
        const y = latlng.getLat();
        // const vrpData = Object.values(nodeList);
        //2. Object.values(NODE_MAP) ëŠ” ìˆœì„œë¥¼ ë³´ì¥í•˜ì§€ ì•ŠëŠ” ê°ì²´ì˜ ê°’ì„ ë°°ì—´ë¡œ ë§Œë“­ë‹ˆë‹¤. ìˆœì„œê°€ ëœë¤ìœ¼ë¡œ ë°”ë€Œë©´ ì•ˆë˜ëŠ” ê²½ìš° ajaxì—ì„œë„ ë¦¬ìŠ¤íŠ¸ë¥¼ ì‚¬ìš©í•´ì•¼í•©ë‹ˆë‹¤.
        $.ajax({
            url: '/vrp',
            type: 'post',
            contentType: "application/json",
            data: JSON.stringify(nodeList),
            success: function (result) {
                if (result.code != 'SUCC') {
                    // alert("ê²½ë¡œ ìµœì í™”ì— ì‹¤íŒ¨ í•˜ì˜€ìŠµë‹ˆë‹¤.");
                    spinOff();
                    return;
                }
                const data = result.data;
                displayData(data);
                drawPath(totalPathPointList);
            },
            error: function () {
                // alert("ê²½ë¡œ ìµœì í™”ì— ì‹¤íŒ¨ í•˜ì˜€ìŠµë‹ˆë‹¤.");
                spinOff();
            }
        });
    }

    function goVrp1(courseList) { // response ëŒ€ì‹  courseListë¥¼ ëª…ì‹œì ìœ¼ë¡œ ì‚¬ìš©í•˜ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤.
        clearAnimation();
        clearManualMarkers();
        spinOn();

        // var latlng = map.getCenter();  // ì´ ë¶€ë¶„ì€ ë” ì´ìƒ í•„ìš”í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
        // const x = latlng.getLng();
        // const y = latlng.getLat();
        // alert(courseList);
        $.ajax({
            url: '/vrp1',  // ì˜¬ë°”ë¥¸ ì—”ë“œí¬ì¸íŠ¸ (/vrp1)
            type: 'POST',  // ì˜¬ë°”ë¥¸ HTTP ë©”ì„œë“œ (POST)
            contentType: "application/json",
            data: JSON.stringify(courseList), // CourseDTO ë¦¬ìŠ¤íŠ¸ë¥¼ JSONìœ¼ë¡œ ë³€í™˜í•˜ì—¬ ì „ì†¡
            success: function (result) {
                if (result.code != 'SUCC') {
                    spinOff();
                    return;
                }

                const data = result.data;

                displayData(data);
                drawPath(totalPathPointList);
            },
            error: function () {
                // alert("vrp1 ì‹¤íŒ¨")
                spinOff();
            }
        });
    }

    function fetchApplyList(bNum) {

        console.log(bNum);
        $.ajax({
            url: `/list/${bNum}`,
            type: "GET",
            success: function (response) {
                console.log("ì‹ ì²­ ëª©ë¡ ì¡°íšŒ ì„±ê³µ:", response);
                displayApplyList(response);
            },
            error: function (error) {
                console.error("ì‹ ì²­ ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨:", error);
                alert('ì‹ ì²­ ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨:' + error.responseJSON.message);
            },
        });
    }
    async function displayApplyList(applyList) {
        console.log("displayApplyList í˜¸ì¶œ ì‹œì‘", applyList);
        const participantList = $("#participant-list");
        const participantCount = $("#participant-count");
        participantList.empty();
        participantCount.text(applyList.length + "ëª…");
        countPeople1 = urlParams.get("countPeople");
        if (applyList.length === 0) {
            participantList.append("<li>ì‹ ì²­ìê°€ ì—†ìŠµë‹ˆë‹¤.</li>");
            console.log("ì‹ ì²­ìê°€ ì—†ìŠµë‹ˆë‹¤.");
            return;
        }

        for (const apply of applyList) {
            console.log("apply ìˆœíšŒ ì‹œì‘:", apply);

            let userGender = apply.userGender;
            let userId = apply.userId;
            let userNickName = apply.userNickName;
            let userAddress = apply.userAddress;
            const loginUserId = '[[${session.loginId}]]';


            // **2. ì¡°ê±´ í™•ì¸: userId ë¹„êµ ë° PStatus í™•ì¸**
            if (userId === loginUserId && apply.pstatus === 1) {
                // **3. "ê²°ì œí•˜ê¸°" ë²„íŠ¼ ìˆ¨ê¸°ê¸°**
                const payButton = document.getElementById('pay-button');
                if (payButton) {
                    payButton.style.display = 'none';
                }
            }

            if (applyList.length >= countPeople1 && loginUserId === apply.userId && apply.pstatus === 1) { // ì‹ ì²­ì ìˆ˜ì™€ ëª¨ì§‘ ì¸ì› ë¹„êµ (NEW!)
                // .memo-section í´ë˜ìŠ¤ë¥¼ ê°€ì§„ ìš”ì†Œ ì°¾ê¸°
                const memoSection = document.querySelector('.memo-section');

                // memo-section ìš”ì†Œê°€ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
                if (memoSection) {
                    // ìƒˆë¡œìš´ button ìš”ì†Œ ìƒì„±
                    const successButton = document.createElement('button');

                    // button ìš”ì†Œì— ì†ì„± ë° í´ë˜ìŠ¤ ì¶”ê°€
                    successButton.id = 'success';
                    successButton.textContent = 'ì—¬í–‰ ì™„ë£Œ'; // ë²„íŠ¼ í…ìŠ¤íŠ¸ ì„¤ì •

                    // ë²„íŠ¼ í´ë¦­ ì‹œ AJAX ìš”ì²­ ë³´ë‚´ê¸°
                    successButton.onclick = function () {
                        $.ajax({
                            type: 'POST',
                            url: '/boardToHistory',  // ì„œë²„ URL
                            data: {BNum: bNum},  // bnum ê°’ì„ ì „ì†¡
                            success: function (response) {
                                alert(response);

                                window.location.href = `/RWriteForm?bNum=${bNum}`;
                            },
                            error: function (error) {
                                console.error(error);
                            }
                        });
                    };

                    // memo-section ìš”ì†Œì— button ìš”ì†Œ ì¶”ê°€
                    memoSection.appendChild(successButton);



                }
            }

            console.log("ê¸°ë³¸ ì •ë³´ - ì„±ë³„:", userGender, "ì•„ì´ë””:", userId, "ë‹‰ë„¤ì„:", userNickName, "ì£¼ì†Œ:", userAddress);

            const nickNames = [...new Set(userNickName.split(",").map(name => name.trim()))];
            const genders = [...new Set(userGender.split(",").map(gender => gender.trim()))];

            console.log("ìœ ë‹ˆí¬í•œ ë‹‰ë„¤ì„ë“¤:", nickNames);
            console.log("ìœ ë‹ˆí¬í•œ ì„±ë³„ë“¤:", genders);

            if (!userAddress) {
                console.log("ì£¼ì†Œê°€ ì—†ìŠµë‹ˆë‹¤. user:", apply);

                // ì£¼ì†Œê°€ ì—†ëŠ” ê²½ìš° ë°”ë¡œ ì²˜ë¦¬
                if (nickNames.length === genders.length) {
                    for (let i = 0; i < nickNames.length; i++) {
                        const nickName = nickNames[i];
                        const gender = genders[i];
                        let listItem = `
                    <li>
                        ${nickName} (${gender})
                    </li>
                    `;
                        participantList.append(listItem);
                        console.log("ì£¼ì†Œì—†ìŒ - ë¦¬ìŠ¤íŠ¸ ì•„ì´í…œ ì¶”ê°€(ë‹‰ë„¤ì„/ì„±ë³„):", listItem);
                    }
                } else {
                    let listItem = `
                <li>
                    ${userNickName} (${userGender})

                </li>
                `;
                    participantList.append(listItem);
                    console.log("ì£¼ì†Œì—†ìŒ - ë¦¬ìŠ¤íŠ¸ ì•„ì´í…œ ì¶”ê°€(ë‹‰ë„¤ì„/ì„±ë³„):", listItem);
                }
                console.log("ì£¼ì†Œì—†ìŒ - ë‹¤ìŒ applyë¡œ ë„˜ì–´ê°");
                continue;
            }

            const geocoder = new kakao.maps.services.Geocoder();

            geocoder.addressSearch(userAddress, function (result, status) { // ì½œë°± í•¨ìˆ˜ ë°©ì‹
                if (status === kakao.maps.services.Status.OK) {
                    var coords = new kakao.maps.LatLng(result[0].y, result[0].x);
                    var x = coords.getLng();
                    var y = coords.getLat();
                    console.log("ì£¼ì†Œ ë³€í™˜ ì„±ê³µ ì¢Œí‘œ:", x, y);
                    console.log(userAddress + " ì£¼ì†Œ ë³€í™˜ í™•ì¸");

                    $.ajax({
                        url: '/poi',
                        data: {
                            x: x,
                            y: y,
                            keyword: userAddress
                        },
                        success: function (result) {
                            console.log("POI ì¡°íšŒ ê²°ê³¼:", result);

                            if (result && result.data && result.data.nodeList && result.data.nodeList.length > 0) {
                                const firstPoiItem = result.data.nodeList[0];
                                const addCourseData = {
                                    nodeId: firstPoiItem.id,
                                    name: firstPoiItem.name,
                                    address: firstPoiItem.address,
                                    phone: firstPoiItem.phone,
                                    x: firstPoiItem.x,
                                    y: firstPoiItem.y,
                                    regDt: firstPoiItem.regDt,
                                    modDt: firstPoiItem.modDt
                                };
                                console.log(addCourseData + "ì½”ìŠ¤ ì €ì¥ì „ í™•ì¸")
                                addCourse(addCourseData.nodeId, addCourseData.name, addCourseData.address, addCourseData.phone, addCourseData.x, addCourseData.y, addCourseData.regDt, addCourseData.modDt,1);

                                //ì—¬ê¸°ê°€ ì¤‘ìš”
                                if (nickNames.length === genders.length) {
                                    for (let i = 0; i < nickNames.length; i++) {
                                        const nickName = nickNames[i];
                                        const gender = genders[i];
                                        let listItem = `
                                        <li class="list-group-item" data-x="${x}" data-y="${y}">
                                            ${nickName} (${gender})
                                            <br><span class="badge bg-light text-dark" style="font-size: 0.8rem;">ì£¼ì†Œ: ${userAddress}</span>
                                               ${apply.pstatus === 1 ? 'ê²°ì œì™„ë£Œ' : 'ê²°ì œí•„ìš”'}

                                        </li>
                                    `;
                                        participantList.append(listItem);
                                        console.log("ë¦¬ìŠ¤íŠ¸ ì•„ì´í…œ ì¶”ê°€(ë‹‰ë„¤ì„/ì„±ë³„/ì£¼ì†Œ):", listItem);
                                    }
                                } else {
                                    let listItem = `
                                    <li class="list-group-item" data-x="${x}" data-y="${y}">
                                        ${userNickName} (${userGender})
                                        <br><span class="badge bg-light text-dark" style="font-size: 0.8rem;">ì£¼ì†Œ: ${userAddress}</span>
                                    </li>
                                `;
                                    participantList.append(listItem);
                                    console.log("ë¦¬ìŠ¤íŠ¸ ì•„ì´í…œ ì¶”ê°€(ë‹‰ë„¤ì„/ì„±ë³„/ì£¼ì†Œ):", listItem);
                                }

                            } else {
                                console.error("POI ë°ì´í„° ì—†ìŒ (nodeList)");
                                handleError();
                            }
                        },
                        error: function () {
                            // alert("ì£¼ë³€ ì£¼ì†Œ ê²€ìƒ‰ ì‹¤íŒ¨");
                            // console.error("POI ê²€ìƒ‰ ì‹¤íŒ¨");
                            // handleError();
                        }
                    });

                } else { // ì£¼ì†Œ ë³€í™˜ ì‹¤íŒ¨
                    console.error("ì£¼ì†Œ ë³€í™˜ ì‹¤íŒ¨:", userAddress, status, result);
                    handleError();
                }
            });

            // ì—ëŸ¬ ì²˜ë¦¬ í•¨ìˆ˜ë¡œ ì¤‘ë³µ ì œê±°
            function handleError() {
                if (nickNames.length === genders.length) {
                    for (let i = 0; i < nickNames.length; i++) {
                        const nickName = nickNames[i];
                        const gender = genders[i];
                        let listItem = `
                        <li>
                            ${nickName} (${gender})
                            ${userAddress ? `<br><span class="badge bg-light text-dark" style="font-size: 0.8rem;">ì£¼ì†Œ: ${userAddress}</span>` : ''}

                        </li>
                    `;
                        participantList.append(listItem);
                        console.log("ì—ëŸ¬ë°œìƒ - ë¦¬ìŠ¤íŠ¸ ì•„ì´í…œ ì¶”ê°€(ë‹‰ë„¤ì„/ì„±ë³„/ì£¼ì†Œ):", listItem);
                    }
                } else {
                    let listItem = `
                    <li>
                        ${userNickName} (${userGender})
                        ${userAddress ? `<br><span class="badge bg-light text-dark" style="font-size: 0.8rem;">ì£¼ì†Œ: ${userAddress}</span>` : ''}

                    </li>
                `;
                    participantList.append(listItem);
                    console.log("ì—ëŸ¬ë°œìƒ - ë¦¬ìŠ¤íŠ¸ ì•„ì´í…œ ì¶”ê°€(ë‹‰ë„¤ì„/ì„±ë³„/ì£¼ì†Œ):", listItem);
                }
            }

            console.log("apply ì²˜ë¦¬ ì™„ë£Œ:", apply);
        }
        console.log("displayApplyList í˜¸ì¶œ ì™„ë£Œ");
    }

    function fetchCourseList(bNum) {
        $.ajax({
            url: `/courseList/${bNum}`,
            type: "GET",
            success: function (response) {
                console.log("ì½”ìŠ¤ ëª©ë¡ ì¡°íšŒ ì„±ê³µ:", response);
                // $('.course-b-section > *:not(:first-child)').hide();
                displayCourseList(response);
                goVrp1(response);
            },
            error: function (error) {
                console.error("ì½”ìŠ¤ ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨:", error);
            },
        });
    }

    function displayCourseList(courseList) {

        console.log("displayCourseList í˜¸ì¶œ", courseList);
        const courseASection = $(".course-a-section");
        const courseBSection = $(".course-b-section");

        courseASection.empty();
        let courseAhtml = `<h4><button type="button" class="btn btn-dark btn-sm mt-2 show-address-button" id="showAdress">ì½”ìŠ¤ ì •ë³´ë³´ê¸°</button></h4>`;
        let oLinkValue = "";
        courseList.forEach((course, index) => {
            if (course.address) {
                courseAhtml += `<p style="display: none;" class="address-item course-address"> ${course.name} ì£¼ì†Œ: ${course.address}</p> `;
            }


            if (course.olink) {

                oLinkValue = course.olink;
                const oLinkInput = document.getElementById('oLink');
                const oLink2Element = document.getElementById('oLink2');
                oLinkInput.value = oLinkValue;
                oLink2Element.href = oLinkValue;
            }
        });
        courseASection.html(courseAhtml);
        // // ì²« ë²ˆì§¸ ì½”ìŠ¤ ì •ë³´ì—ì„œ total ê°’ì„ ê°€ì ¸ì™€ì„œ ìœ ë¥˜ë¹„ ê³„ì‚° ë° í‘œì‹œ
        // if (courseList[0]) {
        //     const urlParams = new URLSearchParams(window.location.search);
        //     let countPeople = urlParams.get("countPeople");
        //     if (!countPeople || isNaN(parseInt(countPeople))) {
        //         countPeople = 1;
        //     } else {
        //         countPeople = parseInt(countPeople)
        //     }
        //     const totalDistanceElement = document.getElementById("totalDistance");
        //     if (totalDistanceElement) {
        //         const totalDistanceText = totalDistanceElement.textContent;
        //         const totalDistanceValue = parseFloat(totalDistanceText.replace("km", ""));
        //         const fuelCost = (totalDistanceValue * 1700) / countPeople;
        //         $("#fuel-cost").text(`ìœ ë¥˜ë¹„: ${fuelCost.toLocaleString()} ì›`);
        //         document.getElementById("fuel-cost").dataset.fuelcost = fuelCost;
        //     } else {
        //         $("#fuel-cost").text(`ìœ ë¥˜ë¹„: ________ ì›`);
        //         document.getElementById("fuel-cost").dataset.fuelcost = 0;
        //     }
        // } else {
        //     $("#fuel-cost").text(`ìœ ë¥˜ë¹„: ________ ì›`);
        //     document.getElementById("fuel-cost").dataset.fuelcost = 0;
        // }
    }



    $(document).ready(function () {


        if (bNum) {

            fetchApplyList(bNum)
            fetchCourseList(bNum);

        }

        window.addEventListener('message', function (event) {
            if (event.data === 'paymentComplete') {
                location.href = '/myPageForm';
            }
        });
    });
    bNum = new URLSearchParams(window.location.search).get("bNum");
    totalDistanceElement = document.getElementById("totalDistance");
    totalDistanceText = totalDistanceElement.textContent;
    totalDistanceValue = parseFloat(totalDistanceText.replace("km", ""));
    urlParams = new URLSearchParams(window.location.search);
    const countPeople = urlParams.get('countPeople');
    countPeopleNum = parseInt(countPeople);
    divisor = countPeopleNum - 1;
    fuelCost = totalDistanceValue * 1700 / divisor/ 15;

    // document.getElementById('success').addEventListener('click', function() {
    //     // 2. AJAX ìš”ì²­ (fetch API ì‚¬ìš©)
    //     fetch('/boardToHistory', {
    //         method: 'POST', // POST ìš”ì²­
    //         headers: {
    //             'Content-Type': 'application/x-www-form-urlencoded' // ìš”ì²­ ë³¸ë¬¸ íƒ€ì… ì„¤ì • (request parameter ë°©ì‹)
    //         },
    //         body: `BNum=${bNum}` // ìš”ì²­ ë³¸ë¬¸ì— BNum íŒŒë¼ë¯¸í„° ì „ë‹¬
    //     })
    //         .then(response => {
    //             if (!response.ok) { // HTTP ì‘ë‹µ ìƒíƒœ ì½”ë“œê°€ 200-299 ë²”ìœ„ê°€ ì•„ë‹ˆë©´ ì—ëŸ¬
    //                 return response.text().then(errorMessage => { // ì—ëŸ¬ ë©”ì‹œì§€ ë°›ì•„ì„œ ì²˜ë¦¬
    //                     throw new Error(errorMessage || 'ì„œë²„ ì˜¤ë¥˜ ë°œìƒ'); // ì—ëŸ¬ ë©”ì‹œì§€ ë˜ì§€ê¸° (catchì—ì„œ ì¡í˜)
    //                 });
    //             }
    //             return response.text(); // ì‘ë‹µ bodyë¥¼ í…ìŠ¤íŠ¸ë¡œ íŒŒì‹± (String message)
    //         })
    //         .then(message => {
    //             // ì„±ê³µ ì‹œ ì²˜ë¦¬
    //             alert(message); // ì„œë²„ì—ì„œ ë°›ì€ ë©”ì‹œì§€ ì•Œë¦¼ (ì˜ˆ: "íˆìŠ¤í† ë¦¬ ì €ì¥ ì„±ê³µ")
    //             // ê²Œì‹œê¸€ ìƒì„¸ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
    //             window.location.href = `/RWriteForm?bNum=${bNum}`;
    //         })
    //         .catch(error => {
    //             // ì—ëŸ¬ ë°œìƒ ì‹œ ì²˜ë¦¬
    //             console.error('AJAX ìš”ì²­ ì—ëŸ¬:', error);
    //             if (error.message === 'ì„œë²„ ì˜¤ë¥˜ ë°œìƒ') { // ì¼ë°˜ì ì¸ ì„œë²„ ì˜¤ë¥˜ (500)
    //                 alert('ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    //             } else { // 400 ì—ëŸ¬ ë“± êµ¬ì²´ì ì¸ ì—ëŸ¬ ë©”ì‹œì§€ ì²˜ë¦¬
    //                 alert('ìš”ì²­ ì‹¤íŒ¨: ' + error.message);
    //             }
    //         });
    // });

    function deleteNode(nodeId) {

        $.ajax({
            url: `/deleteNode/${nodeId}`,
            type: 'DELETE',
            success: function (response) {
                if (response === "ì‚­ì œ ì„±ê³µ") {
                    $(`a button#delete-node-${nodeId}`).closest('a').remove();
                    if (MARKER_MAP[nodeId]) {
                        MARKER_MAP[nodeId].setMap(null);
                        delete MARKER_MAP[nodeId];
                    }
                    if (INFO_MAP[nodeId]) {
                        INFO_MAP[nodeId].close();
                        delete INFO_MAP[nodeId];
                    }
                    delete NODE_MAP[nodeId];
                } else {
                    alert("ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: " + response);
                }
            },
            error: function (xhr, status, error) {
                console.log("xhr : " + xhr);
                console.log("status : " + status);
                console.log("error : " + error);
                alert("ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. " + error);
            }
        });
    }

    $(document).ready(function () {
        let courseIndex = 1;
        let selectedNodeIds = [];
        let courseDTOList = []; // CourseDTO ê°ì²´ë¥¼ ì €ì¥í•  ë°°ì—´

        $(document).on('click', '.list-group-item', function (event) {
            event.preventDefault();
            const nodeId = $(this).data('node-id');
            panTo(nodeId);
        });

        $(document).on('click', '.delete-node-button', function () {
            const buttonId = this.id;
            const match = buttonId.match(/delete-node-(\d+)/);
            if (match && match[1]) {
                const nodeId = parseInt(match[1], 10);
                deleteNode(nodeId);
            }
        });
        $(document).on('click', '.add-to-course-button', function () {
            const listItem = $(this).closest('.list-group-item');
            const nodeId = $(this).data('node-id');
            const name = listItem.find('strong').text().trim();
            const address = listItem.find("span.badge:contains('ì£¼ì†Œ')").next('span').text().trim();
            const phone = listItem.find("span.badge:contains('ì „í™”')").next('span').text().trim();
            const x = parseFloat(listItem.data('x'));
            const y = parseFloat(listItem.data('y'));
            const regDt = new Date();
            const modDt = new Date();

            // í´ë¦­ì‹œ ì¦‰ì‹œ ì €ì¥
            addCourse(nodeId, name, address, phone, x, y, regDt, modDt, 0);
        });



        function addCourseToDTO(nodeId, name, address, phone, x, y, regDt, modDt) {
            const bNum = new URLSearchParams(window.location.search).get("bNum");
            const userId = '[[${session.loginId}]]'; // Thymeleafë¥¼ í†µí•´ userIdë¥¼ ì§ì ‘ ì„¤ì •
            const oLink = $("#oLink").val();
            const cStatus = 0;

            if (selectedNodeIds.includes(nodeId)) {
                alert("ì´ë¯¸ ì¶”ê°€ëœ ì½”ìŠ¤ ì…ë‹ˆë‹¤");
                return;
            }

            selectedNodeIds.push(nodeId);

            const courseDTO = {
                id: nodeId,
                name: name,
                address: address,
                phone: phone,
                x: x,
                y: y,
                regDt: regDt,
                modDt: modDt,
                BNum: bNum,
                UserId: userId,
                OLink: oLink,
                CStatus: cStatus
            };

            courseDTOList.push(courseDTO);
        }


    });

    function addCourse(nodeId, name, address, phone, x, y, regDt, modDt ,cStatus) {
        const bNum = new URLSearchParams(window.location.search).get("bNum");
        const userId = '[[${session.loginId}]]'; // Thymeleafë¥¼ í†µí•´ userIdë¥¼ ì§ì ‘ ì„¤ì •
        const oLink = $("#oLink").val();


        const courseDTO = {
            id: nodeId,
            name: name,
            address: address,
            phone: phone,
            x: x,
            y: y,
            regDt: regDt,
            modDt: modDt,
            BNum: bNum,
            UserId: userId,
            OLink: oLink,
            CStatus: cStatus
        };

        const urlParams = new URLSearchParams(window.location.search);
        const bNum2 = urlParams.get("bNum");
        oLink2 = $("#oLink").val();
        const userId2 = `[[${session.loginId}]]`;

        if (!bNum2) {
            alert("ê²Œì‹œê¸€ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.");
            return;
        }
        if (!userId2) {
            alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤");
            return;
        }

        spinOn();

        $.ajax({
            url: '/addCourse',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                courseList: [courseDTO], // ë³€ê²½ëœ ë¶€ë¶„: ë°°ì—´ë¡œ ê°ì‹¸ì„œ ì „ì†¡
                bNum: bNum2,
                oLink: oLink2,
                userId: userId2,
            }),
            success: function (response) { // ì„±ê³µ ì½œë°± (HTTP 200 OK)
                spinOff();
                // alert('ì½”ìŠ¤ ì €ì¥ ì„±ê³µ!'); // ì„±ê³µ ì•Œë¦¼ (ì„ íƒ ì‚¬í•­)
                // loadInitialData(); // ì„±ê³µ ì‹œ ë°ì´í„° ë‹¤ì‹œ ë¡œë“œ (ì„ íƒ ì‚¬í•­)
                // window.location.reload(); // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ (ì„ íƒ ì‚¬í•­)
            },
            error: function (jqXHR) {
                spinOff();
                if (jqXHR.status === 409) { // HTTP ìƒíƒœ ì½”ë“œ 409 Conflict (ì½”ìŠ¤ ìˆ˜ ì´ˆê³¼, ì£¼ì†Œ ì¤‘ë³µ ë“±)
                    // alert('ë”ì´ìƒ ì½”ìŠ¤ë¥¼ ì €ì¥í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤!')

                }
            }
        });
    }

    $(document).on('click', '.show-address-button', function () {
        console.log('ì½”ìŠ¤ ì •ë³´ë³´ê¸° ë²„íŠ¼ í´ë¦­ë¨');
        $('.course-address').toggle();
    });


    // $(document).on('click', '#searchPoiButton', function() {
    //     console.log('ì£¼ë³€ ê´€ê´‘ì§€ ê²€ìƒ‰ ë²„íŠ¼ í´ë¦­ë¨');
    //     $('#summary-title').remove();
    //     $('#summary-section').remove();
    // });
    let manualMarkers = []; // ìˆ˜ë™ ë§ˆì»¤ë“¤ì„ ì €ì¥í•  ë°°ì—´ (â˜…â˜…â˜…â˜…â˜… ì¶”ê°€ â˜…â˜…â˜…â˜…â˜…)
    let manualPolyline = null; // ìˆ˜ë™ ê²½ë¡œ polyline (â˜…â˜…â˜…â˜…â˜… ì¶”ê°€ â˜…â˜…â˜…â˜…â˜…)
    // ì§€ë„ í´ë¦­ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡ (â˜…â˜…â˜…â˜…â˜… ìˆ˜ì •ëœ ë¶€ë¶„ â˜…â˜…â˜…â˜…â˜…)
    kakao.maps.event.addListener(map, 'click', function(mouseEvent) {
        // í´ë¦­í•œ ìœ„ë„, ê²½ë„ ì •ë³´ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤
        var latlng = mouseEvent.latLng;

        // ì¢Œí‘œë¥¼ ì£¼ì†Œë¡œ ë³€í™˜í•©ë‹ˆë‹¤
        geocoder.coord2Address(latlng.getLng(), latlng.getLat(), function(result, status) {
            if (status === kakao.maps.services.Status.OK) {
                var detailAddr = !!result[0].road_address ? '<div>ë„ë¡œëª…ì£¼ì†Œ : '  + result[0].road_address.address_name + '</div>' : '';
                detailAddr += '<div>ì§€ë²ˆ ì£¼ì†Œ : ' + result[0].address.address_name + '</div>';

                var content = detailAddr;

                // // ì •ë³´ì°½ ë‚´ìš© ì„¤ì • ë° í‘œì‹œ
                // $('#clickLatlng').text('í´ë¦­í•œ ì¢Œí‘œ: ' + latlng.getLat() + ', ' + latlng.getLng());
                // $('#clickAddress').html(content);

                // â˜…â˜…â˜…â˜…â˜… ë§ˆì»¤ í‘œì‹œ ê¸°ëŠ¥ ì¶”ê°€ â˜…â˜…â˜…â˜…â˜…
                // 1. ìƒˆ ë§ˆì»¤ ìƒì„± (ê¸°ì¡´ ë§ˆì»¤ ì œê±° X)
                var marker = new kakao.maps.Marker({
                    map: map,
                    position: latlng
                });

                // 2. ë§ˆì»¤ë¥¼ ë°°ì—´ì— ì¶”ê°€ (â˜…â˜…â˜…â˜…â˜… ìˆ˜ì • â˜…â˜…â˜…â˜…â˜…)
                manualMarkers.push(marker);

                // 3. ë§ˆì»¤ ì§€ë„ì— í‘œì‹œ
                marker.setMap(map);

                // // 4. ê²½ë¡œë¥¼ ë‹¤ì‹œ ê·¸ë¦¬ê¸° (â˜…â˜…â˜…â˜…â˜… ì¶”ê°€ â˜…â˜…â˜…â˜…â˜…)
                // drawManualPath();

                // 5. í´ë¦­í•œ ìœ„ì¹˜ ì£¼ì†Œë¡œ POI ê²€ìƒ‰ ë° ì½”ìŠ¤ ì¶”ê°€ (â˜…â˜…â˜…â˜…â˜… ì¶”ê°€ â˜…â˜…â˜…â˜…â˜…)
                const userAddress = result[0].road_address ? result[0].road_address.address_name : result[0].address.address_name;

                // â˜…â˜…â˜…â˜…â˜… í™•ì¸ ì°½ ì¶”ê°€ â˜…â˜…â˜…â˜…â˜…
                if (confirm('ì´ ìœ„ì¹˜ì— ì½”ìŠ¤ë¥¼ ì¶”ê°€í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) { // confirm() í•¨ìˆ˜ë¡œ í™•ì¸ ì°½ í‘œì‹œ
                    searchPoiAndAddCourse(latlng.getLng(), latlng.getLat(), userAddress); // "ì˜ˆ" í´ë¦­ ì‹œ ì½”ìŠ¤ ì¶”ê°€ í•¨ìˆ˜ í˜¸ì¶œ
                } else {
                    console.log("ì½”ìŠ¤ ì¶”ê°€ ì·¨ì†Œ"); // "ì•„ë‹ˆì˜¤" ë˜ëŠ” ì·¨ì†Œ í´ë¦­ ì‹œ ì½˜ì†”ì— ë©”ì‹œì§€ ì¶œë ¥ (ì„ íƒ ì‚¬í•­)
                }
                // â˜…â˜…â˜…â˜…â˜… í™•ì¸ ì°½ ì¶”ê°€  ë â˜…â˜…â˜…â˜…â˜…

                // â˜…â˜…â˜…â˜…â˜… ë§ˆì»¤ í‘œì‹œ ê¸°ëŠ¥ ì¶”ê°€  ë â˜…â˜…â˜…â˜…â˜…
            }
        });
    });

    // POI ê²€ìƒ‰ ë° ì½”ìŠ¤ ìë™ ì¶”ê°€ í•¨ìˆ˜ (â˜…â˜…â˜…â˜…â˜… ì¶”ê°€ â˜…â˜…â˜…â˜…â˜…)
    function searchPoiAndAddCourse(x, y, userAddress) {
        // alert(userAddress+"useraddress ì—¬ë¶€ í™•ì¸")
        $.ajax({
            url: '/poi',
            data: {
                x: x,
                y: y,
                keyword: userAddress
            },
            success: function (result) {
                console.log("POI ì¡°íšŒ ê²°ê³¼:", result);
                if (result && result.data && result.data.nodeList && result.data.nodeList.length > 0) {
                    const firstPoiItem = result.data.nodeList[0];
                    const addCourseData = {
                        nodeId: firstPoiItem.id,
                        name: firstPoiItem.name,
                        address: firstPoiItem.address,
                        phone: firstPoiItem.phone,
                        x: firstPoiItem.x,
                        y: firstPoiItem.y,
                        regDt: firstPoiItem.regDt,
                        modDt: firstPoiItem.modDt
                    };
                    console.log(addCourseData+"ì½”ìŠ¤ ì €ì¥ì „ í™•ì¸")
                    addCourse(addCourseData.nodeId, addCourseData.name, addCourseData.address, addCourseData.phone, addCourseData.x, addCourseData.y, addCourseData.regDt, addCourseData.modDt,0);
                window.location.reload();
                }
            },
            error: function () {
                console.error("POI ê²€ìƒ‰ ì—ëŸ¬");
            }
        });
    }
    // ìˆ˜ë™ ë§ˆì»¤ ë° ê²½ë¡œ ì œê±° í•¨ìˆ˜ (â˜…â˜…â˜…â˜…â˜… ì¶”ê°€ â˜…â˜…â˜…â˜…â˜…)
    function clearManualMarkers() {
        if (manualMarkers && manualMarkers.length > 0) {
            for (var i = 0; i < manualMarkers.length; i++) {
                manualMarkers[i].setMap(null); // ì§€ë„ì—ì„œ ë§ˆì»¤ ì œê±°
            }
            manualMarkers = []; // ë°°ì—´ ë¹„ìš°ê¸°
        }
        if (manualPolyline) {
            manualPolyline.setMap(null); // ì§€ë„ì—ì„œ ê²½ë¡œ ì œê±°
            manualPolyline = null; // ë³€ìˆ˜ ì´ˆê¸°í™”
        }
    }
</script>
</body>
</html>